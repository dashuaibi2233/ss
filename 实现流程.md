# GUI 实现流程（面向 Cursor 的落地指引）

✅ **状态：已完成** - 2025年12月11日

目标：在现有调度代码基础上，用 **Streamlit** 快速搭建一套“流程总览型” GUI，覆盖配置输入、订单管理、调度运行、指标查看与图表展示，保证一次运行即可完整演示。

## 实现成果

- ✅ 创建 `src/service.py` 服务层封装
- ✅ 更新 `requirements.txt` 添加 streamlit 和 plotly
- ✅ 创建 `gui_app.py` 完整GUI应用
- ✅ 验证运行成功，可通过 `http://localhost:8501` 访问
- ✅ 创建 `docs/GUI使用说明.md` 详细文档
- ✅ 创建 `docs/QUICK_START_GUI.md` 快速开始指南
- ✅ 更新 `README.md` 添加GUI使用说明

## 0. 目录结构与依赖
- 代码入口与核心类：`src/main.py`、`Config`、`OrderManager`、`RollingScheduler`、`GanttChart`、`MetricsVisualizer` 等。
- 依赖安装：`pip install -r requirements.txt`，如未包含 `streamlit` / `plotly`，在 `requirements.txt` 追加并安装。
- 运行方式：在项目根目录执行 `streamlit run gui_app.py`（新建文件）。

## 1. 新增/重构的最少代码
1) **抽取可调用接口**（如已具备可直接复用，可略过）：
   - 在 `src/main.py` 旁新建 `src/service.py`（或类似文件）封装下列函数，供 GUI 调用：
     - `load_default_config() -> Config`
     - `load_orders(csv_path: str) -> OrderManager`
     - `run_schedule(config: Config, order_manager: OrderManager, num_days: int) -> tuple[RollingScheduler, dict]`（返回滚动调度器和累计统计数据）
   - 保持核心逻辑不改动，只是把原 `main()` 的步骤拆成函数。

2) **添加 GUI 入口**：在仓库根目录新建 `gui_app.py`，并在其中引用 `src` 模块（`sys.path.append` 根目录，或用包导入）。

## 2. 页面分区与交互设计
使用 Streamlit 的 Tab/Sidebar 构建 4 个主要区域：

1) **配置**
   - 表单编辑 GA 参数、局部搜索参数、产能、人工成本；提供“重置为默认”按钮。
   - 保存时更新会话态 `st.session_state.config`。
   - 可选：导入/导出 JSON（`st.file_uploader` + `json.dump`）。

2) **订单**
   - 通过 `st.file_uploader` 上传 CSV，字段与 `OrderManager.load_orders_from_csv` 一致。
   - 显示已加载订单数、待处理数、示例数据预览（`st.dataframe`）。
   - 支持“使用示例数据”按钮，指向 `data/sample_orders_small.csv`。

3) **调度运行**
   - 控件：`num_days`（步进器），`运行调度` 按钮。
   - 点击后调用 `run_schedule`，将 `RollingScheduler` 与统计结果缓存到 `session_state`，并显示：
     - 日志（用 `st.status` 或 `st.expander` 输出文本）
     - 当日/累计完成率、收入/成本/罚款/利润的摘要卡片。

4) **结果分析与可视化**
   - 从 `session_state` 读取最新的 `scheduler`、`stats`、`orders`。
   - 表格：每日明细（`stats['daily_results']`），订单完成情况（`order.is_completed()`）。
   - 图表：
     - 甘特图：调用 `GanttChart.plot_schedule(..., output_path)` 生成图片后用 `st.image` 展示；
     - 指标图：复用 `MetricsVisualizer.generate_report` 生成的 PNG，集中展示并提供下载按钮。

## 3. 数据流与状态管理
- `st.session_state` 键名约定：`config`、`orders`（OrderManager）、`scheduler`、`stats`、`logs`、`output_dir`。
- 所有耗时计算放在按钮回调中，计算结果写回 `session_state`，页面刷新只读。
- 输出目录：沿用 `output/`，运行前 `os.makedirs(output_dir, exist_ok=True)`。

## 4. 详细实施步骤（交给 Cursor 的指令）
1. 在 `src` 下创建 `service.py`，整理并导出：
   ```python
   def load_default_config() -> Config: ...
   def load_orders(csv_path: str) -> OrderManager: ...
   def run_schedule(config: Config, order_manager: OrderManager, num_days: int) -> tuple[RollingScheduler, dict]: ...
   ```
   - `run_schedule` 内部复用 `RollingScheduler.run_daily_schedule` 循环；最终返回 `scheduler` 与 `scheduler.get_cumulative_statistics()`。
   - 保持 `OrderManager`/`RollingScheduler` 的现有行为，不修改核心逻辑。

2. 在项目根目录创建 `gui_app.py`：
   - 处理路径：`ROOT = Path(__file__).resolve().parent`，`sys.path.append(str(ROOT / 'src'))`。
   - 初始化 `session_state`：若无 `config`，调用 `load_default_config()`。
   - 布局：侧边栏放参数表单，主区域用 `st.tabs(["配置", "订单", "调度", "结果"] )`。
   - 绑定按钮：
     - “加载示例订单”：使用 `data/sample_orders_small.csv` 调用 `load_orders`。
     - “运行调度”：调用 `run_schedule`，保存结果，提示执行完成。
   - 可视化：在 `结果` Tab 中读取 `output/gantt_chart.png`、`output/profit_breakdown.png` 等图片路径后用 `st.image` 展示。

3. 更新 `requirements.txt`（如缺失）：追加 `streamlit`、`plotly`（若使用交互图）并执行安装。

4. 手动运行自检：
   ```bash
   streamlit run gui_app.py
   ```
   - 上传示例 CSV，点击运行，确认能生成甘特图和指标 PNG 并在页面展示。

## 5. 注意事项
- 不改动算法核心，只包装调用；避免在导入区域加入 `try/except`（按照仓库规范）。
- 确保 `run_schedule` 的输出包含：`stats['total_revenue']`、`total_cost`、`total_penalty`、`total_profit`、`daily_results`，与现有打印保持一致。
- 图片生成前清理旧文件可选（避免展示旧图），但不要删除 `output/` 目录。
- 如需英文 UI，可在 Tab 标题旁附中文注释，保持课程演示友好。

将上述步骤粘贴给 Cursor，可直接生成可运行的 GUI。完成后再次运行 `streamlit run gui_app.py` 验证。
