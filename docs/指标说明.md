# 系统指标说明文档

## 两套指标体系

系统中存在**两套不同的指标**，分别用于不同的目的：

### 1. 算法内部指标（GA优化过程）

**用途**：用于遗传算法的适应度评估和优化过程

**特点**：
- 计算的是**整个规划期**（未来30个slot）的预估值
- 包含所有未来可能的收入、成本、罚款
- 用于指导算法寻找更好的调度方案
- **不代表实际业务结果**

**输出位置**：
```
优化完成（算法内部指标，用于优化过程）
GA适应度: ¥165,741.00
  规划期总收入: ¥177,220.00
  规划期总成本: ¥6,660.00
  规划期总罚款: ¥4,819.00 (未来30个slot的预估)
```

**为什么罚款会很高？**
- 这是对**未来30个slot**所有订单的罚款预估
- 包含了很多还没到期的订单
- 用于让GA知道"如果这样排会有多少风险"

---

### 2. 实际业务指标（真实财务数据）

**用途**：反映每天实际执行的财务结果

**特点**：
- 只统计**当天实际执行**的6个slot的数据
- 罚款按**截止时间触发**，每个订单只罚一次
- 符合业务规则：罚款 = 订单总金额 × 10%
- **这是真实的财务指标**

**输出位置**：
```
📊 第 1 天实际业务指标
======================================================================
  收入: ¥63,230.00 (当天实际生产)
  成本: ¥2,220.00 (当天人工成本)
  罚款: ¥1,134.00 (当天新增罚款)
  利润: ¥59,876.00
======================================================================
```

**罚款计算示例**（Day 1）：
```
订单2: due_slot=6 (Day1内), 未完成
  罚款 = 150 × 50 × 10% = ¥750

订单5: due_slot=4 (Day1内), 未完成
  罚款 = 80 × 48 × 10% = ¥384

Day 1 新增罚款 = 750 + 384 = ¥1,134 ✅
```

---

## 为什么会有两套指标？

### 算法需求 vs 业务需求

| 维度 | 算法内部指标 | 实际业务指标 |
|------|-------------|-------------|
| **时间范围** | 未来30个slot | 当天6个slot |
| **计算目的** | 指导优化方向 | 反映真实结果 |
| **罚款逻辑** | 预估所有风险 | 按到期触发 |
| **是否累加** | 不累加（每天重算） | 累加（多日汇总） |

### 具体例子

**Day 1 的两套数据对比**：

```
算法内部指标（优化完成时）：
  规划期总罚款: ¥4,819.00
  ↓
  这是对未来30个slot的预估，包含：
  - 订单2 (due=6): ¥750
  - 订单5 (due=4): ¥384
  - 订单3 (due=8): ¥1,080
  - 订单4 (due=10): ¥2,040
  - ... 其他还没到期的订单
  = 总共约¥4,819

实际业务指标（当天执行后）：
  当天新增罚款: ¥1,134.00
  ↓
  只罚今天到期且未完成的订单：
  - 订单2 (due=6, Day1内): ¥750
  - 订单5 (due=4, Day1内): ¥384
  = ¥1,134 ✅
```

---

## 最终报表（多日累计）

**这是最重要的指标**，用于评估整个调度系统的效果：

```
============================================================
调度指标（多日累计）
============================================================

财务指标:
  总收入:        ¥179,050.00
  总成本:        ¥6,660.00
  总罚款:        ¥1,134.00
  总利润:        ¥171,256.00

订单指标:
  总订单数:      20
  完成订单数:    16
  完成率:        80.0%

每日明细:
  第1天: 收入=¥63,230.00, 成本=¥2,220.00, 罚款=¥1,134.00, 利润=¥59,876.00
  第2天: 收入=¥72,675.00, 成本=¥2,220.00, 罚款=¥0.00, 利润=¥70,455.00
  第3天: 收入=¥43,145.00, 成本=¥2,220.00, 罚款=¥0.00, 利润=¥40,925.00
============================================================
```

### 验证一致性

```python
# 收入累加
总收入 = 63,230 + 72,675 + 43,145 = 179,050 ✅

# 成本累加
总成本 = 2,220 + 2,220 + 2,220 = 6,660 ✅

# 罚款累加（按截止时间触发）
总罚款 = 1,134 + 0 + 0 = 1,134 ✅

# 利润累加
总利润 = 59,876 + 70,455 + 40,925 = 171,256 ✅

# 验证公式
总利润 = 总收入 - 总成本 - 总罚款
171,256 = 179,050 - 6,660 - 1,134 ✅
```

---

## 如何理解日志输出

### 完整的Day 1日志结构

```
第 1 天调度 - 早上8:00
======================================================================
待处理订单: 20 个

[GA优化过程...]

优化完成（算法内部指标，用于优化过程）  ← 这是算法视角
GA适应度: ¥165,741.00
  规划期总收入: ¥177,220.00
  规划期总成本: ¥6,660.00
  规划期总罚款: ¥4,819.00 (未来30个slot的预估)  ← 不是真实罚款

[执行当天生产...]

  ⚠️  订单 2 到期未完成，罚款 ¥750.00  ← 真实罚款明细
  ⚠️  订单 5 到期未完成，罚款 ¥384.00

======================================================================
📊 第 1 天实际业务指标  ← 这是业务视角
======================================================================
  收入: ¥63,230.00 (当天实际生产)
  成本: ¥2,220.00 (当天人工成本)
  罚款: ¥1,134.00 (当天新增罚款)  ← 真实罚款 = 750 + 384
  利润: ¥59,876.00
  截止当天累计完成: 16/20 (80.0%)  ← 截止Day1累计完成的订单
======================================================================

📊 第 1 天结果:
  累计完成订单: 16/20  ← 与上面一致
  累计完成率: 80.0%
```

### 关键点

1. **"优化完成"的罚款¥4,819** = 算法预估，包含未来所有风险
2. **"实际业务指标"的罚款¥1,134** = 真实罚款，只罚今天到期的
3. **最终报表用的是实际业务指标**，所以是正确的

---

## 常见疑问

### Q1: 为什么Day 1的罚款有两个数字？

**A**: 
- ¥4,819 是**算法内部预估**（未来30个slot）
- ¥1,134 是**实际业务罚款**（当天到期的订单）

### Q2: 哪个数字是对的？

**A**: 
- 对于**算法优化**来说，¥4,819是对的（用于指导搜索）
- 对于**业务报表**来说，¥1,134是对的（真实财务数据）

### Q3: 为什么Day 2和Day 3的罚款是0？

**A**: 
因为Day 2和Day 3没有订单到期：
- Day 1: 订单2(due=6)和订单5(due=4)到期 → 罚款¥1,134
- Day 2: 没有订单在slot 7-12到期 → 罚款¥0
- Day 3: 没有订单在slot 13-18到期 → 罚款¥0

### Q4: 如果我只关心最终结果，看哪个？

**A**: 
看**"调度指标（多日累计）"**那一块，那是真实的财务指标。

### Q5: "累计完成订单"是什么意思？

**A**: 
这是**截止当天**已经完成的订单总数：
- Day 1结束: 累计完成16/20 (完成了16个订单)
- Day 2结束: 累计完成16/20 (还是16个，Day2没有新完成的)
- Day 3结束: 累计完成17/20 (又完成了1个，总共17个)

**注意**：这个数字应该**单调递增**或**保持不变**，不会减少。

---

## 代码实现位置

### 算法内部指标

**文件**: `src/scheduler/rolling_scheduler.py`

**方法**: `run_optimization()`

```python
# 第144-148行
print(f"\n优化完成（算法内部指标，用于优化过程）")
print(f"GA适应度: ¥{final_schedule.profit:.2f}")
print(f"  规划期总收入: ¥{final_schedule.revenue:.2f}")
print(f"  规划期总成本: ¥{final_schedule.cost:.2f}")
print(f"  规划期总罚款: ¥{final_schedule.penalty:.2f} (未来{planning_horizon}个slot的预估)")
```

### 实际业务指标

**文件**: `src/scheduler/rolling_scheduler.py`

**方法**: `run_daily_schedule()` → `execute_daily_production()` → `calculate_daily_penalty()`

```python
# 第100-107行
print("\n" + "="*70)
print(f"📊 第 {current_day + 1} 天实际业务指标")
print("="*70)
print(f"  收入: ¥{daily_stats['revenue']:,.2f} (当天实际生产)")
print(f"  成本: ¥{daily_stats['cost']:,.2f} (当天人工成本)")
print(f"  罚款: ¥{daily_stats['penalty']:,.2f} (当天新增罚款)")
print(f"  利润: ¥{daily_stats['profit']:,.2f}")
```

### 最终报表

**文件**: `src/main.py`

**方法**: 主程序最后的统计输出

```python
cumulative_stats = scheduler.get_cumulative_statistics()
print(f"  总收入:        ¥{cumulative_stats['total_revenue']:,.2f}")
print(f"  总成本:        ¥{cumulative_stats['total_cost']:,.2f}")
print(f"  总罚款:        ¥{cumulative_stats['total_penalty']:,.2f}")
print(f"  总利润:        ¥{cumulative_stats['total_profit']:,.2f}")
```

---

## 总结

| 指标类型 | 用途 | 时间范围 | 罚款逻辑 | 是否累加 |
|---------|------|---------|---------|---------|
| **算法内部** | 优化过程 | 未来30个slot | 预估所有风险 | 否 |
| **实际业务** | 财务报表 | 当天6个slot | 按到期触发 | 是 |

**记住**：
- 看到"优化完成"的数字 → 这是算法视角，用于优化
- 看到"实际业务指标"的数字 → 这是业务视角，真实财务
- 看到"调度指标（多日累计）" → 这是最终结果，用于评估

**最重要的是最终报表，那里的数据是自洽且正确的！** ✅
