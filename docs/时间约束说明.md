# 订单时间约束说明

## 1. 核心约束

### 1.1 订单到达时间 (release_slot)
- **定义**: 订单到达系统的时间点
- **约束**: 订单只能在到达后才能被安排生产
- **滚动调度**: 每天早上8点调度时，只调度 `release_slot <= current_slot` 的订单
- **示例**: 如果订单的 `release_slot=7`，则该订单在第2天早上8点（slot=7）才能被调度

### 1.2 订单截止时间 (due_slot)
- **定义**: 截止日期当天早上8点
- **约束**: 订单必须在 `due_slot` 之前完成，不能在 `due_slot` 这个时段生产
- **时间窗口**: 订单的生产时间窗口为 `[release_slot, due_slot)`（左闭右开区间）
- **罚款判定**: 当 `current_slot >= due_slot` 时，如果订单未完成则触发罚款

### 1.3 示例说明

假设每天有6个slot（8:00-10:00, 10:00-12:00, 12:00-14:00, 14:00-16:00, 16:00-18:00, 18:00-20:00）

| 订单 | release_slot | due_slot | 可生产时段 | 截止时间 |
|------|--------------|----------|-----------|---------|
| 1    | 1            | 6        | slot 1-5  | 第1天20:00 |
| 2    | 7            | 12       | slot 7-11 | 第2天20:00 |
| 3    | 13           | 18       | slot 13-17| 第3天20:00 |

**订单1**: 
- 第1天早上8点到达（slot=1）
- 可以在slot 1, 2, 3, 4, 5生产
- 必须在第1天20:00（slot=6开始）之前完成
- 如果第2天早上8点（slot=7）时还未完成，则触发罚款

## 2. 代码实现

### 2.1 解码器约束 (decoder.py)
```python
# 订单只能在 [release_slot, due_slot) 时间窗口内生产
if (product == target_product and 
    capacity > 0 and 
    order.release_slot <= slot < order.due_slot):
    available_slots.append((slot, line, capacity))
```

### 2.2 滚动调度过滤 (order_manager.py)
```python
# 每天早上8点调度时，只调度已到达的订单
eligible_orders = [
    order for order in self.orders.values()
    if order.remaining > 0 and order.release_slot <= current_start_slot
]
```

### 2.3 罚款判定 (rolling_scheduler.py)
```python
# 当current_slot >= due_slot时，订单已超期
if current_slot >= order.due_slot:
    if order.remaining > 0 and not order.penalized:
        # 触发罚款
        penalty = order.quantity * order.unit_price * PENALTY_RATE
```

## 3. CSV数据格式

```csv
order_id,product,quantity,release_slot,due_slot,unit_price
16,1,270,3,35,53
```

- **release_slot=3**: 订单在slot 3到达（第1天12:00-14:00）
- **due_slot=35**: 订单必须在slot 35之前完成（第6天早上8点）
- **可生产时段**: slot 3-34

## 4. 滚动调度流程

### 第1天早上8点 (slot=1)
- 调度所有 `release_slot <= 1` 的订单
- 未到达的订单（`release_slot > 1`）不参与调度

### 第2天早上8点 (slot=7)
- 调度所有 `release_slot <= 7` 的订单
- 检查 `due_slot <= 7` 的未完成订单，触发罚款

### 第N天早上8点 (slot = (N-1)*6 + 1)
- 调度所有 `release_slot <= current_slot` 的订单
- 检查 `due_slot <= current_slot` 的未完成订单，触发罚款

## 5. 关键修改点

1. **decoder.py**: 将 `slot <= due_slot` 改为 `slot < due_slot`
2. **rolling_scheduler.py**: 将罚款判定从 `due_slot <= current_slot` 改为 `current_slot >= due_slot`
3. **测试文件**: 更新所有验证逻辑，使用 `<` 而不是 `<=`
4. **文档注释**: 明确说明 `due_slot` 是截止日期当天早上8点
