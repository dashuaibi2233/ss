# å®Œæ•´æ—¶é—´çº¦æŸæ€»ç»“

## æ ¸å¿ƒä¸šåŠ¡è§„åˆ™

### 1. è®¢å•åˆ°è¾¾è§„åˆ™
- **æ¯å¤©æ—©ä¸Š8ç‚¹è¿›è¡Œç”Ÿäº§è®¡åˆ’å®‰æ’**
- **å½“å¤©æ—©ä¸Š8ç‚¹ä¹‹ååˆ°è¾¾çš„è®¢å•æ”¾åœ¨ç¬¬äºŒå¤©ç»Ÿä¸€å®‰æ’**

### 2. è®¢å•æˆªæ­¢è§„åˆ™
- **åˆåŒæˆªæ­¢æ—¶é—´å‡æŒ‡æˆªæ­¢æ—¥æœŸå½“å¤©æ—©ä¸Š8ç‚¹**
- **è®¢å•å¿…é¡»åœ¨æˆªæ­¢æ—¥æœŸå½“å¤©æ—©ä¸Š8ç‚¹ä¹‹å‰å®Œæˆ**

## æ—¶é—´çº¦æŸå®ç°

### 1. release_slotï¼ˆè®¢å•åˆ°è¾¾æ—¶é—´ï¼‰

**å®šä¹‰**: è®¢å•åˆ°è¾¾ç³»ç»Ÿçš„æ—¶é—´ç‚¹

**çº¦æŸ**: 
- è®¢å•åªèƒ½åœ¨åˆ°è¾¾åæ‰èƒ½è¢«å®‰æ’ç”Ÿäº§
- æ¯å¤©æ—©ä¸Š8ç‚¹è°ƒåº¦æ—¶ï¼Œåªè°ƒåº¦ `release_slot <= current_slot` çš„è®¢å•

**ä»£ç å®ç°**:
```python
# order_manager.py
def get_eligible_orders(self, current_start_slot):
    eligible_orders = [
        order for order in self.orders.values()
        if order.remaining > 0 and order.release_slot <= current_start_slot
    ]
    return eligible_orders
```

### 2. due_slotï¼ˆè®¢å•æˆªæ­¢æ—¶é—´ï¼‰

**å®šä¹‰**: æˆªæ­¢æ—¥æœŸå½“å¤©æ—©ä¸Š8ç‚¹

**CSVè½¬æ¢**: CSVä¸­çš„åŸå§‹ `due_slot` ä¼šè‡ªåŠ¨è½¬æ¢åˆ°æˆªæ­¢æ—¥æœŸå½“å¤©æ—©ä¸Š8ç‚¹
```python
# è½¬æ¢å…¬å¼
adjusted_due_slot = ((original_due_slot - 1) // 6 + 1) * 6 + 1
```

**è½¬æ¢ç¤ºä¾‹**:
| CSVä¸­çš„due_slot | è½¬æ¢å | è¯´æ˜ |
|----------------|--------|------|
| 1-6 | 7 | ç¬¬1å¤©ä»»æ„æ—¶æ®µ â†’ ç¬¬2å¤©æ—©ä¸Š8ç‚¹ |
| 7-12 | 13 | ç¬¬2å¤©ä»»æ„æ—¶æ®µ â†’ ç¬¬3å¤©æ—©ä¸Š8ç‚¹ |
| 13-18 | 19 | ç¬¬3å¤©ä»»æ„æ—¶æ®µ â†’ ç¬¬4å¤©æ—©ä¸Š8ç‚¹ |

**çº¦æŸ**:
- è®¢å•åªèƒ½åœ¨ `[release_slot, due_slot)` æ—¶é—´çª—å£å†…ç”Ÿäº§
- è®¢å•ä¸èƒ½åœ¨ `due_slot` è¿™ä¸ªæ—¶æ®µç”Ÿäº§

**ä»£ç å®ç°**:
```python
# decoder.py
if (product == target_product and 
    capacity > 0 and 
    order.release_slot <= slot < order.due_slot):  # æ³¨æ„æ˜¯ <ï¼Œä¸æ˜¯ <=
    available_slots.append((slot, line, capacity))
```

### 3. ç½šæ¬¾åˆ¤å®š

**è§¦å‘æ¡ä»¶**: å½“ `current_slot >= due_slot` æ—¶ï¼Œå¦‚æœè®¢å•æœªå®Œæˆåˆ™è§¦å‘ç½šæ¬¾

**ä»£ç å®ç°**:
```python
# rolling_scheduler.py
def calculate_daily_penalty(self, current_day):
    # è®¡ç®—å½“å¤©æ—©ä¸Š8ç‚¹çš„slot
    current_slot = self.order_manager.time_to_slot(current_day, hour=8)
    
    for order in orders:
        # å½“current_slot >= due_slotæ—¶ï¼Œè®¢å•å·²è¶…æœŸ
        if current_slot >= order.due_slot:
            if order.remaining > 0 and not order.penalized:
                penalty = order.quantity * order.unit_price * PENALTY_RATE
                # è§¦å‘ç½šæ¬¾
```

## å®Œæ•´ç¤ºä¾‹

### CSVæ•°æ®
```csv
order_id,product,quantity,release_slot,due_slot,unit_price
1,2,220,1,6,70
```

### æ•°æ®è§£è¯»

**åŸå§‹æ•°æ®**:
- `release_slot=1`: ç¬¬1å¤©æ—©ä¸Š8ç‚¹åˆ°è¾¾
- `due_slot=6`: ç¬¬1å¤©4:00-8:00ï¼ˆCSVä¸­çš„åŸå§‹å€¼ï¼‰

**è‡ªåŠ¨è½¬æ¢**:
- `due_slot`: 6 â†’ 7ï¼ˆç»Ÿä¸€åˆ°ç¬¬2å¤©æ—©ä¸Š8ç‚¹ï¼‰

**æ—¶é—´çª—å£**:
- å¯ç”Ÿäº§æ—¶æ®µ: slot 1, 2, 3, 4, 5, 6ï¼ˆä¸åŒ…æ‹¬slot 7ï¼‰
- æˆªæ­¢æ—¶é—´: ç¬¬2å¤©æ—©ä¸Š8ç‚¹

### è°ƒåº¦æµç¨‹

**ç¬¬1å¤©æ—©ä¸Š8ç‚¹ (slot=1)**:
- âœ… è®¢å•1å·²åˆ°è¾¾ï¼ˆ`release_slot=1 <= 1`ï¼‰
- âœ… è®¢å•1å¯ä»¥è¢«è°ƒåº¦
- ğŸ“… è®¢å•1å¯ä»¥åœ¨slot 1-6ç”Ÿäº§

**ç¬¬1å¤©å…¶ä»–æ—¶æ®µ (slot 2-6)**:
- ğŸ”§ è®¢å•1ç»§ç»­ç”Ÿäº§

**ç¬¬2å¤©æ—©ä¸Š8ç‚¹ (slot=7)**:
- â° æ£€æŸ¥è®¢å•1çš„æˆªæ­¢æ—¶é—´ï¼ˆ`due_slot=7`ï¼‰
- âŒ å¦‚æœè®¢å•1æœªå®Œæˆï¼ˆ`remaining > 0`ï¼‰ï¼Œè§¦å‘ç½šæ¬¾
- âš ï¸ è®¢å•1ä¸èƒ½åœ¨slot 7ç”Ÿäº§ï¼ˆå› ä¸º `slot < due_slot` çš„çº¦æŸï¼‰

## å…³é”®ä¿®æ”¹ç‚¹æ€»ç»“

### 1. decoder.py
```python
# ä¿®æ”¹å‰: slot <= due_slot
# ä¿®æ”¹å: slot < due_slot
order.release_slot <= slot < order.due_slot
```

### 2. rolling_scheduler.py
```python
# ä¿®æ”¹å‰: åœ¨å½“å¤©ç»“æŸæ—¶åˆ¤å®š
current_slot = (current_day + 1) * SLOTS_PER_DAY
if order.due_slot <= current_slot:

# ä¿®æ”¹å: åœ¨å½“å¤©æ—©ä¸Š8ç‚¹åˆ¤å®š
current_slot = self.order_manager.time_to_slot(current_day, hour=8)
if current_slot >= order.due_slot:
```

### 3. order_manager.py
```python
# æ–°å¢: due_slotè‡ªåŠ¨è½¬æ¢
def load_orders_from_csv(self, filepath, adjust_due_slot=True):
    if adjust_due_slot:
        due_day = (original_due_slot - 1) // 6
        adjusted_due_slot = (due_day + 1) * 6 + 1
```

## æµ‹è¯•éªŒè¯

### æµ‹è¯•1: è§£ç å™¨çº¦æŸ
```bash
python test_decoder_release_slot.py
```
âœ… è®¢å•åªèƒ½åœ¨ `[release_slot, due_slot)` æ—¶é—´çª—å£å†…ç”Ÿäº§

### æµ‹è¯•2: æ»šåŠ¨è°ƒåº¦è¿‡æ»¤
```bash
python test_rolling_schedule_release_slot.py
```
âœ… æ¯å¤©åªè°ƒåº¦å·²åˆ°è¾¾çš„è®¢å•ï¼ˆ`release_slot <= current_slot`ï¼‰

### æµ‹è¯•3: due_slotè½¬æ¢
```bash
python test_due_slot_adjustment.py
```
âœ… CSVä¸­çš„æˆªæ­¢æ—¶é—´æ­£ç¡®è½¬æ¢åˆ°æˆªæ­¢æ—¥æœŸå½“å¤©æ—©ä¸Š8ç‚¹

## æ–‡æ¡£æ¸…å•

1. âœ… `docs/æ—¶é—´çº¦æŸè¯´æ˜.md` - æ—¶é—´çº¦æŸè¯¦ç»†è¯´æ˜
2. âœ… `docs/ä¿®æ”¹æ€»ç»“.md` - ä»£ç ä¿®æ”¹æ€»ç»“
3. âœ… `docs/due_slotè½¬æ¢è¯´æ˜.md` - due_slotè½¬æ¢é€»è¾‘
4. âœ… `docs/å®Œæ•´æ—¶é—´çº¦æŸæ€»ç»“.md` - æœ¬æ–‡æ¡£ï¼ˆå®Œæ•´æ€»ç»“ï¼‰

## ä½¿ç”¨å»ºè®®

1. **é»˜è®¤è¡Œä¸º**: ä½¿ç”¨ `adjust_due_slot=True`ï¼ˆé»˜è®¤ï¼‰ï¼Œç¬¦åˆä¸šåŠ¡è§„åˆ™
2. **æŸ¥çœ‹è½¬æ¢**: åŠ è½½è®¢å•æ—¶ä¼šæ‰“å°è½¬æ¢ä¿¡æ¯
3. **è¿è¡Œæµ‹è¯•**: ä¿®æ”¹ä»£ç åè¿è¡Œä¸‰ä¸ªæµ‹è¯•è„šæœ¬éªŒè¯
4. **ç†è§£çº¦æŸ**: è®°ä½æ—¶é—´çª—å£æ˜¯ `[release_slot, due_slot)` å·¦é—­å³å¼€åŒºé—´
