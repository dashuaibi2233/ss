# 调度算法说明（升级版草案）

> 本文档面向课程论文与算法设计说明，使用抽象语言描述调度算法框架及其升级方向。
> 不涉及具体代码、类名或函数名，仅讨论模型、机制与流程层面的问题。

---

## 1. 问题背景与基线框架（简述）

考虑一个具有多条生产线、多个产品种类的离散制造场景：

- 时间被离散为等长的时间段，每条生产线在任一时间段内至多生产一种产品；
- 每个订单具有产品类型、需求数量、到达时刻与截止时间；
- 目标是在给定的规划窗口内，为所有已到达订单分配产能，以最大化总利润。

利润由三部分构成：

1. 收入：已完成数量乘以单价，对所有订单求和；
2. 成本：不同时间段具有不同的人工成本，生产活动会产生相应开销；
3. 罚款：若订单在截止时间前未完全完成，则按照订单总金额的一定比例一次性罚款。

基线方法采用“**遗传算法 + 局部搜索 + 滚动调度**”的混合框架：

- 遗传算法在编码空间中搜索调度方案，提供全局性的结构探索；
- 局部搜索在遗传算法给出的优秀方案附近进行微调，以进一步提升质量；
- 滚动调度按照固定节奏重复触发，在每个调度周期针对当前订单池重新优化未来若干天的计划。

在该基线下，主要问题在于：

- 单一种群的进化过程容易在某一类策略模式附近早熟收敛，难以保持多样化的搜索风格；
- 局部搜索以随机扰动为主，缺乏对“高罚款风险订单”和“高成本时段”的定向关注；
- 罚款机制呈现明显的离散跳变特征，简单的贪心改进难以为跨越这一跳变预留足够的探索空间。

---

## 2. 算法升级概述

为解决上述问题，同时保持既有滚动调度流程与对外接口不变，本项目在两个互补方向上对基线框架进行结构性升级：

1. 在全局搜索层面，引入 **岛模型并行遗传算法**，增强搜索多样性与策略风格并存能力；
2. 在局部精化层面，引入 **风险驱动的定向局部搜索（带受控退火接受）**，让局部搜索围绕罚款风险与成本压力进行有方向的调整。

### 2.1 岛模型并行遗传算法（全局层面）

在基线方法中，所有候选解属于同一个种群，在统一的选择压力下进化。这种结构虽然简单，但在复杂调度问题中存在两方面不足：

- 难以同时维持多种“调度风格”，例如偏重利润最大化、偏重按期交付或偏重结构探索；
- 一旦某类风格在种群中占据主导，其他潜在有价值的风格会迅速被淘汰，导致搜索空间被“单一视角”主导。

岛模型并行遗传算法通过将整体种群拆分为多个相对独立的子种群（岛），并在岛之间周期性交换少量精英个体，实现：

- **多风格并行进化**：不同岛可以采用各自的参数与偏好设置，在同一问题上长期维持多种策略模式；
- **结构性多样性维护**：即便某个岛发生早熟收敛，其他岛仍可在不同区域继续探索，降低整体陷入局部最优的风险；
- **跨岛经验共享**：通过精英迁移，将某一岛上发现的优秀结构传播到其他岛，使不同策略风格之间能够相互借鉴。

在本项目中，岛模型特别强调三类具有代表性的岛：

- 利润导向岛：更倾向于追求短期利润最大化；
- 交付导向岛：更重视订单按期完成与违约率控制；
- 探索导向岛：通过更大的扰动与更宽松的选择策略，主动维持结构多样性。

在评价阶段依然使用统一的利润指标对所有候选解进行比较，但在进化过程中，各岛内部可以通过不同的偏好设置体现上述差异化风格。这样，在一次滚动调度中就能同时生成多种风格的候选方案，为后续精化与决策提供更丰富的备选空间。

### 2.2 风险驱动的定向局部搜索（局部层面）

在基线方法中，局部搜索通过随机邻域对候选解进行扰动，并采用“只接受更优解”的贪心策略。这种方式的局限在于：

- 邻域操作不区分订单的重要程度，也不区分时间段的成本差异，容易将计算资源浪费在对全局利润影响有限的局部；
- 纯贪心接受策略难以跨越“短期变差、长期变好”的情形，尤其是在罚款存在明显跳变时。

风险驱动的定向局部搜索在两个方面做出改进：

1. **围绕“风险”构建搜索重点**：
   - 通过综合考虑潜在罚款金额、已分配产能与总需求的缺口、距离截止时间的紧迫程度等因素，为每个订单构造风险分数；
   - 将搜索资源优先投向风险最高的订单及其相关时间段，例如高金额但接近未完成的订单，或即将到期且产能紧张的订单。

2. **在局部接受准则中加入受控退火机制**：
   - 在局部搜索早期，以一定概率接受略差解，使搜索有能力穿越局部谷底，探索那些可能在罚款层面带来大幅改善的结构；
   - 随着迭代进行，接受略差解的概率逐渐降低，最终回归以改进为主的保守策略；
   - 整个过程限定在局部搜索阶段内部，用于在小范围内调节探索与利用的平衡，而不会改变全局评价标准。

通过这两点改进，局部搜索从“对编码随机扰动的通用微调器”转变为“围绕罚款风险与成本压力的结构化精化器”：

- 高风险订单的时间位置、产能分配和相邻订单的排列成为优先调整目标；
- 高成本时段中的低价值生产活动成为优先压缩对象；
- 在局部范围内允许短暂牺牲部分表面利润，以换取更大概率的罚款消除或成本优化。

---

## 3. 升级方向与后续章节预告

- 后续章节将分别从“岛模型并行遗传算法的机制设计”和“风险驱动局部搜索的策略设计”两个角度，详细描述：
  - 多岛结构如何组织、如何迁移精英、如何体现异质化偏好；
  - 风险分数的构成、目标导向邻域的构造方式、受控退火接受的具体规则。
- 对于滚动调度本身的触发机制、窗口冻结策略与历史信息利用方式，仅做必要的补充说明，不改变既有主流程。

> 本文档当前处于“升级版草案”阶段，仅完成算法升级的整体概述。随着后续实现推进，将逐步补充细化章节，并保持与实现文档 `/update/DEV_NOTES.md` 的同步。

---

## 4. 岛模型并行遗传算法的执行机制（抽象）

本节在整体概述的基础上，以更流程化的方式描述岛模型并行遗传算法的执行机制，仍然只讨论抽象概念，不涉及任何实现细节。

### 4.1 多岛结构与类型分工

在升级后的框架中，整体候选解集合被划分为若干个相对独立的子群体，每个子群体被视作一座“岛”：

- 每个岛内部拥有固定规模的候选解集合，并按照遗传算法的标准步骤独立进化；
- 不同岛之间在大部分代数中互不干扰，仅在少数“迁移代”交换少量优秀个体；
- 各岛在初始化与参数偏好上可以有所差异，从而长期维持不同的搜索风格。

在典型配置下，可以区分三类具有代表性的岛：

- **利润导向岛**：更关注短期利润的提升，在内部更偏向保留高收益结构；
- **交付导向岛**：更重视订单按期完成情况，在初始化与内部排序时对截止时间更为敏感；
- **探索导向岛**：通过更强的扰动和更宽松的选择策略主动保持结构多样性，为其他岛提供新模式来源。

所有岛在评价阶段仍然使用同一利润指标进行比较，只是在“如何生成下一代候选解”这一过程中，采用不同的风格与偏好。

### 4.2 执行步骤（单次调度周期内）

在某一次调度周期中，岛模型并行遗传算法的执行可分为以下阶段：

1. **初始化阶段**
   - 确定需要优化的时间窗口长度与编码维度；
   - 为每个岛分别生成一批初始候选解：
     - 其中一部分完全随机，用于覆盖尽可能多的结构模式；
     - 另一部分基于启发式生成，例如按照截止时间对订单进行排序，以形成更易满足交付要求的初始方案；
   - 不同类型的岛在随机与启发式之间采用不同配比，以体现其各自侧重的策略风格。

2. **迭代进化阶段**
   - 在每一代中，对每个岛独立执行以下步骤：
     1. 根据当前岛内候选解的利润水平，选择一批“父代”用于繁衍；
     2. 通过交叉操作将不同候选解的结构特征进行重组，产生新的“子代”；
     3. 通过变异操作对部分编码位置施加小幅扰动，引入新的结构可能性；
     4. 将旧一代的优秀候选解与新产生的候选解一起排序，形成下一代种群。
   - 在此过程中，不同类型的岛可以通过调整“选择压力”和“扰动强度”体现差异：
     - 利润导向岛在选择阶段更偏向利润较高的方案；
     - 探索导向岛在变异阶段引入更大幅度的扰动；
     - 交付导向岛在初始化和内部排序时对“接近截止的订单”给予更多关注。

3. **精英迁移阶段**
   - 每经过若干代（由外部参数控制迁移间隔），触发一次跨岛迁移：
     - 在每个岛内部选取若干当前最优方案作为“精英”；
     - 根据预先设定的拓扑结构（例如简单环形），将精英从一个岛传递到下一个岛；
     - 接收方岛在保留自身优秀候选解的同时，用迁入精英替换一部分较差个体。
   - 通过这种低频率、小规模的精英迁移：
     - 可以让不同策略风格之间共享优秀结构；
     - 又不会让某一风格迅速“同化”全部岛，从而保持整体搜索的多样性。

4. **终止与解输出阶段**
   - 在达到最大代数或连续若干代未观察到明显改进后，整体进化过程终止；
   - 在所有岛中选择利润最高的候选解作为本次调度周期的全局最优方案；
   - 将该方案交给后续的局部搜索与解码步骤，进入精化与指标计算阶段。

### 4.3 与单种群框架的兼容性

岛模型并行遗传算法被设计为基于基线框架的**向上兼容扩展**：

- 当岛的数量退化为 1 个，且迁移机制被关闭时，整体行为与单种群遗传算法等价；
- 当未显式开启岛模型开关时，系统仍然采用原有的单种群进化策略，保证历史行为与现有对外接口不受影响；
- 只有在明确激活多岛结构时，系统才会在内部使用上述多岛并行进化与精英迁移机制。

这种设计使得：

- 现有的滚动调度流程与上层调用方无需感知内部结构变化；
- 可以在同一套实现中方便地对比“单种群”和“岛模型”两种全局搜索方式，只需调整配置而无需修改调用代码。

---

## 5. 风险驱动局部搜索的执行机制（抽象）

本节在 2.2 节的概述基础上，从“执行步骤”的角度描述风险驱动局部搜索的工作方式，仍然只讨论机制与流程，不涉及任何具体实现细节。

### 5.1 风险评分：在订单维度刻画“紧急且高代价”的对象

在局部搜索阶段，我们面对的是某一次滚动调度中已经较为优秀的候选方案。此时，与其在整个编码空间上做无差别扰动，不如识别出“最有可能导致重大罚款或效率损失”的少数订单，并将搜索资源集中在它们周围。为此，需要为每个订单构造一个综合风险分数。

典型的风险分数可以由以下三部分组成：

1. **潜在罚款贡献**：
   - 若某订单未完成，则其一旦超期所产生的罚款金额，等于订单总金额乘以罚款比例；
   - 该值越大，说明该订单一旦违约，对整体利润的破坏越严重。

2. **需求缺口程度**：
   - 在当前候选方案下，可以根据已经分配给该订单的产能来估计其“完成度”；
   - 需求缺口可以用“尚未覆盖的需求量占总需求量的比例”来刻画；
   - 缺口越大，说明即便还没到截止时间，也已经处于明显“供不应求”状态。

3. **截止紧迫度**：
   - 按滚动调度当前窗口的起点，估算距离订单截止时间还剩多少个可用时间段；
   - 若剩余时间段极少或已经超期，则紧迫度接近 1；
   - 若截止时间远在规划窗口之外，则紧迫度接近 0。

通过对上述三个分量做适当归一化，并用可配置的权重进行线性组合，即可得到一个在 [0,1] 区间内的风险分数：

- 分数越高的订单，在罚款金额、需求缺口和时间紧迫性三个维度上越“危险”；
- 已经完全完成的订单会被赋予近似 0 的风险分数，从而在后续步骤中被自动忽略。

### 5.2 目标导向邻域：围绕高风险订单的结构调整

在获得每个订单的风险分数后，局部搜索不再对所有订单一视同仁，而是重点围绕高风险订单及其相关时间段构造邻域：

1. **沿时间与产线维度的调整（对应编码中的生产结构）**：
   - 对于被判定为高风险的订单，重点关注其产品在时间轴上的产能分布；
   - 邻域操作会优先挑选那些与高风险订单产品相关、并位于其可生产窗口内的时间段，尝试：
     - 在同一条产线的不同时间段之间重新分配该产品；
     - 将其从成本较高的时间段移向成本较低、或更有利于按期完成的时间段；
   - 若在当前解中难以找到足够的候选位置，则退化为普通的随机扰动，以保证算法稳健性。

2. **沿订单优先级维度的调整（对应编码中的服务顺序）**：
   - 在描述订单服务顺序的编码结构中，优先考虑将高风险订单向“更靠前”的位置移动；
   - 邻域操作会从高风险订单中随机挑选一个，将其在顺序结构中的位置与某个更前的位置交换；
   - 这样，在随后的解码过程中，高风险订单有更大概率在产能分配时优先得到满足。

通过这两类目标导向邻域，局部搜索从“对所有结构做无偏扰动”转变为“对高风险订单周围的局部结构做重点微调”，从而用有限的迭代预算换取更高的罚款控制与成本效率。

### 5.3 受控退火接受：在探索与利用之间取得平衡

即便拥有良好的风险评分与邻域设计，若始终坚持“只接受更优解”，局部搜索仍可能被局部最优点所困。为此，在风险驱动局部搜索中引入了一个简单、可控的退火式接受机制：

1. **基本规则**：
   - 若新方案的利润不低于当前方案，则无条件接受；
   - 若新方案略差，则以一定概率仍然接受，用于“翻越”局部谷底。

2. **概率的时间调度**：
   - 在局部搜索早期，将“接受略差解”的最大概率设置为一个相对较高的初始值；
   - 随着迭代推进，这个最大概率按预设的衰减系数逐步降低；
   - 即便在后期，也保留一个很小的概率下限，防止完全退化为僵死的纯贪心搜索。

3. **作用范围限定在局部阶段内部**：
   - 退火机制只影响“是否接受某次局部扰动结果”这一决策；
   - 不会改变全局层面对方案好坏的评价标准，也不会影响滚动调度的触发节奏和窗口设置。

### 5.4 与基线局部搜索的兼容性

风险驱动局部搜索被设计为对基线 ILS/VNS 的补充路径，而非完全替代：

- 若相关开关未被激活，则局部搜索仍采用原有的随机邻域与贪心接受规则；
- 只有在显式开启相应配置时，才会在局部阶段使用风险评分、目标导向邻域与退火接受；
- 因此，同一套系统可以方便地在“经典 ILS/VNS”与“风险驱动局部搜索”之间切换，进行对比实验。

这种设计保证了：

- 已有实验与结果在不开启新路径时仍然可复现；
    - 新机制的引入不会打破整个滚动调度框架的稳定性，只是在局部阶段提供了更丰富、更精细的搜索策略。

---

## 6. 效果与讨论（升级版最小对比）

在同一数据集与相同规划窗口下，对比“基线（单种群 GA + 随机局部搜索/贪心接受）”与“升级版（岛模型并行 GA + 风险驱动局部搜索/受控退火接受）”：

- 指标维度：
  - 利润（总收入 − 总成本 − 总罚款）
  - 罚款金额（一次性罚款规则）
  - 按期率与平均完成率
  - 运行时间（仅作参考，受随机性与参数影响）
- 观察到的典型变化（定性）：
  - 岛模型并行 GA 在同等代数内更易维持多风格候选方案，降低早熟收敛概率；在罚款风险较高的数据分布下，常出现“罚款显著下降、利润随之提升”的现象；
  - 风险驱动局部搜索将有限的微调预算集中在高风险订单与高成本时段上，结合受控退火，可越过“短期变差、长期变好”的局部谷底；在接近截止且需求缺口较大的订单集中场景下，违约数量与罚款金额往往下降；
  - 成本方面，在不影响可行性的前提下，局部搜索倾向于将同类产品从高成本时段适度平移至成本较低的时段，形成对利润的次要正向贡献。
- 兼容性与可退化：
  - 关闭岛模型或将岛数设为 1 时，整体行为与单种群 GA 等价；
  - 关闭风险驱动局部搜索时，局部阶段回退到随机扰动与贪心接受；
  - 因此，旧版结果在不开启新路径时仍可复现，升级机制仅在开关激活后生效。

### 6.1 最小对比结果（示例）

- 在“20 单的小型数据集”与“固定 10 天规划窗口”的示例下，升级版在默认参数下出现了轻微的利润下降与按期率下滑，主要原因是：
  - 局部阶段早期的受控退火存在小概率接受略差解，使得少数订单的完成时序发生位移，触发一次罚款；
  - 岛模型的多样性维护并未在该小型场景带来显著的罚款缓解效益，导致收益提升不足以抵消罚款增量。
- 该现象具有可调性：
  - 降低早期接受概率或提高高风险阈值，可减少“略差解”的接受频率；
  - 调整岛类型比例与迁移周期，使“交付导向”风格在罚款风险较高时段占据更大权重。

