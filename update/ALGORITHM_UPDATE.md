# 调度算法升级说明：岛模型并行 GA + 风险驱动局部搜索

> 本文档作为 `docs/ALGORITHM.md` 的演进补充说明，只讨论在现有 **“GA + ILS/VNS + 滚动调度”** 主框架下的两条结构性升级方向：
>
> - 升级方向一：将单种群 GA 升级为 **岛模型并行遗传算法（Island Model GA）**
> - 升级方向二：将“随机邻域 + 贪心接受”的 ILS/VNS 升级为 **风险驱动的定向局部搜索（带受控退火接受）**
>
> 现有主流程（滚动调度触发时机、数据流转、结果使用方式）保持不变，仅在“如何全局搜索”“如何局部精化”两个层面升级算法机制与策略。

---

## 1. 算法升级动机（原算法的问题）

### 1.1 单种群 GA 的局限

当前实现中，GA 引擎（`src/ga/engine.py`）采用的是**单种群、单目标偏好的标准遗传算法**：

- 种群中的所有个体共享同一套参数（交叉率、变异率、选择方式等）。
- 适应度统一采用“总利润 = 收入 - 成本 - 罚款”（见 `docs/ALGORITHM.md` 2.3 节与 `ga/fitness.py`）。
- 进化过程中通过精英保留控制收敛，但**缺乏显式的多样性维护与探索机制**。

在本项目的调度问题中，存在如下典型现象：

- **早熟收敛**：
  - 高利润方案往往来自“高金额订单 + 低成本时段”的组合，一旦种群聚集到某一类结构后，后续变异/交叉大多在邻近结构中微调，很难跳出这一类模式。
  - 由于罚款为“未完成即罚 10%”，哪怕多完成一点高金额订单，也可能带来巨额收益，单种群很容易围绕某个特定的“高额订单组合”收缩，忽视其他结构差异较大的可行方案。
- **解的稳定性不足**：
  - 不同启动种子、不同订单到达场景下，最终方案波动较大：有的解偏重盈利（多压缩到高成本夜班、但罚款低），有的解偏重成本（白天少加班、但多罚款）。
  - 单种群很难在一次运行中同时兼顾“利润最大化、成本平衡、违约风险控制”这三类偏好。

### 1.2 随机 + 贪心局部搜索的局限

当前局部搜索模块（`src/local_search/ils_vns.py`）本质是：

- **邻域选择**：
  - `N1`：随机选择一条生产线和两个时间段，交换 `Gene1` 中的产品类型。
  - `N2`：随机选两个订单位置，交换 `Gene2` 中的优先级。
- **搜索策略**：
  - 在 GA 最优解上，反复随机选择 `N1` 或 `N2`，生成邻域解，再用贪心接受（仅当适应度更好才接受）。

这类“随机扰动 + 贪心接受”的 ILS/VNS 存在几个核心问题：

- **优化方向不明确**：
  - 邻域操作不区分“高风险订单”和“低价值订单”，也不区分“高成本时段”和“空闲低成本时段”，只是对编码随机打乱。
  - 在当前“离散罚款”结构下，这种无差别扰动很容易把能源浪费在对整体利润影响很小的局部上。
- **极易陷入局部最优**：
  - 贪心接受意味着“任何略差解都不会被接受”，一旦当前解周围的所有直接邻域都略差，搜索就停止。
  - 考虑到罚款是“未完成即罚 10%”，某些关键订单如果需要短期内增加成本（例如临时用夜班高成本时段赶工）才能完成，系统必须**先接受暂时“看上去更差”的解**，才能最终减少巨额罚款，但贪心策略无法做到。

### 1.3 罚款机制对算法的特殊要求

项目中的罚款规则（`docs/ALGORITHM.md` 1.1 节、`ga/fitness.py`）：

- 罚款定义为：
  - 若订单 `o` 未完全完成，则罚款 = `0.1 × q_o × s_o`（订单总金额的 10%）。
- 这意味着：
  - **罚款是离散跳变的**：从“只差 1 件没完成”到“全完成”，罚款会从 10% 总额直接跳到 0。
  - 对高金额订单而言，这一跳变非常巨大。

因此算法需要具备：

- 能够在全局层面识别“哪些订单存在高罚款风险”。
- 优先在这些高风险订单周围做结构性调整（例如把这些订单向更有产能的时段迁移，或者优先保证其产能分配）。
- 在局部搜索中，有策略地允许“短期利润下降换取长期大幅减罚款”的操作。

这正是本次升级要解决的核心：

- 用**岛模型并行 GA**增强全局多样性与多目标偏好表达能力。
- 用**风险驱动的定向局部搜索（带受控退火接受）**，让局部优化真正服务于“罚款结构 + 成本结构”的业务本质。

---

## 2. 原算法框架简述（作为对比背景）

当前算法整体框架可以概括为三层（详见 `docs/ALGORITHM.md` 与 `src/scheduler/rolling_scheduler.py`）：

1. **上层：滚动调度**
   - 每天 8:00 触发一次调度。
   - 收集所有未完成且已到达的订单，形成订单池。
   - 冻结当前时间之前已执行的 slot，对未来若干天（如 10 天 × 6 slot）的窗口进行优化。

2. **中层：单种群 GA 全局搜索**
   - 使用双层编码 `Chromosome = [Gene1, Gene2]`：
     - `Gene1` 为 产线-时间-产品结构（`NUM_LINES × H`）。
     - `Gene2` 为订单优先级排列。
   - 单一种群在利润目标下进化，采用：
     - 锦标赛选择、交叉（Gene1 + Gene2）、变异、精英保留。
   - 输出一个 GA 最优解作为候选调度方案。

3. **下层：ILS/VNS 局部搜索精化**
   - 以 GA 最优解为初始解，通过随机邻域 `N1/N2` 做微小扰动。
   - 使用贪心接受策略，仅在适应度提升时接受新解。
   - 作为附加精化步骤，提高解质量。

> 本次升级在保持上述“三层结构 + 数据流”不变的前提下：
>
> - 将“中层 GA”从**单种群**升级为**多岛并行 + 精英迁移**的结构。
> - 将“下层局部搜索”从**随机 + 贪心**升级为**风险驱动 + 受控退火接受**的策略。

---

## 3. 升级方向一：岛模型并行遗传算法

### 3.1 为什么单种群不足以支撑当前调度问题

结合现有实现和业务结构，单种群 GA 的问题主要在于：

- **缺少显式的多目标偏好分化**：
  - 适应度是一个标量“总利润”，但利润本身由“收入 / 成本 / 罚款”三部分构成，且罚款呈离散跳变。
  - 单种群在进化中往往形成某一种隐含偏好（如“极端压罚款但不控制成本”或“压成本但牺牲部分高价值订单”），很难同时保留多种政策风格。
- **难以长期保持多样性**：
  - 在 `engine.py` 中依靠变异 + 部分随机初始化维持多样性，但这类“无方向的随机”在进化后期常常仅起到噪声作用，不能系统地探索结构差异大的解。
- **对滚动调度场景不友好**：
  - 每天 8:00 的优化都在更新订单池，早期天数的“好策略模式”如果没有在种群中保留，很难被后续日期复用。

这些问题在“罚款是离散跳变 + 订单随机到达”的场景下会被进一步放大：一旦某类策略（例如：优先保证大单，夜班多加班）在种群内占主导，其他策略（例如：压缩夜班、接受部分小单罚款）就会迅速被淘汰，导致系统只能看到“单一风格的调度方案”。

### 3.2 岛模型 GA 如何提升全局搜索能力

岛模型并行 GA 的核心思想是：

- 将整体种群拆分为多个**相对独立的子种群（岛）**，每个岛独立进化。
- 在一定代数间隔上，执行**精英迁移**：从每个岛抽取少量精英个体，发送到其他岛。
- 岛内主要承担“策略风格的深入挖掘”，岛间迁移负责“优秀结构的跨风格传播”。

相对于当前单种群 GA，岛模型带来三项关键改进：

- **多样性来源结构化**：不同岛在初始化、算子参数、选择策略上可以带有不同偏好，形成稳定共存的“策略派系”，而不是依赖单一变异率来注入噪声。
- **探索与利用解耦**：
  - 部分岛可以偏“探索”：更大的变异、更宽松的选择，以广泛搜索结构空间；
  - 部分岛偏“利用”：较强精英保留、偏向优胜者，快速收敛到高质量策略；
  - 通过迁移把探索岛发现的好模式导入利用岛，将利用岛的成熟模式反向传播给探索岛。
- **防止全局早熟**：就算某个岛早熟陷入局部最优，其他岛仍然可能在搜索其他区域；跨岛迁移可以为停滞的岛注入新血，恢复进化活力。

### 3.3 异质岛设计：利润导向 / 交付导向 / 探索导向

在本项目中，岛模型不只是“物理上多群体”，而是**业务偏好上的异质多群体**。结合利润结构：

- **利润导向岛（Profit-Oriented Island）**
  - 偏好：最大化短期总利润。
  - 特征：
    - 罚款权重保持现有设定，重点追求高金额订单的充分完成。
    - 允许更多使用高成本夜班，只要整体利润为正。
    - 选择算子偏向高适应度个体，精英保留比例略高。
  - 作用：快速给出“利润最大化”的候选解，类似当前 GA 的主风格。

- **交付导向岛（Delivery-Oriented Island）**
  - 偏好：降低违约率，尽量完成更多订单（尤其是高金额订单）。
  - 特征：
    - 在适应度评价或内部排序时，对“未完成订单数量、高金额订单未完成情况”给予更高惩罚。
    - 在初始化和变异中，倾向将高金额订单放到更靠前的时间段和产能更高的产线。
  - 作用：形成一类“保交付”的调度风格，为滚动调度下的长期信誉和订单履约提供备选方案。

- **探索导向岛（Exploration-Oriented Island）**
  - 偏好：增加结构多样性，主动尝试非常规安排。
  - 特征：
    - 更高的变异率、更丰富的交叉策略组合；
    - 初始化时故意引入一些“非直觉性”结构（例如部分时间段空闲、集中生产同一产品以压切换成本等）。
  - 作用：承担大部分“全局搜路”的任务，在不同编码结构之间大跨度跳跃，为其他岛提供创新候选解。

通过这三类岛：

- 系统在单次调度内就能同时产生“利润极致”“交付优先”“结构多样性”三类风格的解。
- 滚动调度多日运行后，各岛还会形成相对稳定的策略模式，可供长期比较和选择。

### 3.4 精英迁移机制：在信息共享与多样性之间平衡

精英迁移是岛模型的关键机制，其设计需兼顾：

- **信息共享**：不能让每个岛长期“闭门造车”，要让好的模式有机会扩散。
- **多样性保护**：迁移过于频繁或迁入个体过多，会导致所有岛同质化，再次退化为单种群。

在本项目场景下，合理的机制可以描述为：

1. **迁移节奏**：
   - 每隔固定代数（例如每 10–20 代），触发一次迁移事件。
   - 在 GA 内部循环中，这是在当前代数区间完成常规选择-交叉-变异后，额外插入的步骤，不改变单岛内部进化逻辑。

2. **迁移内容**：
   - 每个岛选取少量精英（例如前 1–3 个）作为“输出候选”。
   - 对于利润导向岛，重点输出“高利润且违约较少”的解；
   - 对于交付导向岛，重点输出“违约极低”的解，即便短期利润略逊。

3. **迁移方式**：
   - 使用“环形”或“全连接但限额”的方式将精英分发到其他岛：
     - 利润岛 → 导入到交付岛和探索岛，帮助它们学习“高收益结构”；
     - 交付岛 → 导入到利润岛和探索岛，提醒其他岛“如何降低罚款风险”；
     - 探索岛 → 将结构差异大的个体发送给所有岛，扩大搜索空间。
   - 每个岛在接收外来个体时，只保留少量表现好的迁入个体，并丢弃一部分本岛尾部个体，以维持岛内规模稳定。

4. **与原 GA 的本质差异**：
   - 原 GA：
     - 单一种群，所有个体在统一选择压力下进化，多样性仅依赖随机变异。
   - 岛模型 GA：
     - 明确划分多个“策略派系”，各自沿不同偏好方向深挖；
     - 通过精英迁移在“多派系之间传递经验”，在更高层次上实现“探索-利用”的平衡。

从系统层面看，岛模型并行 GA 不改变 `run_ga` 的“输入订单 + 配置 → 输出最优染色体”这一接口，只是将内部的“如何产生这一个最优解”的方式从“单池进化”升级为“多岛并行 + 精英迁移”。

---

## 4. 升级方向二：风险驱动的局部搜索（带受控退火接受）

### 4.1 “风险”的定义：基于罚款规则的业务视角

在当前罚款规则下，订单的**风险水平**可以从两方面理解：

1. **罚款金额潜力**：
   - 对订单 `o`，其潜在罚款 = `0.1 × q_o × s_o`。
   - 单位时间 / 单位产能上，这意味着：
     - 高金额、大批量订单一旦未完成，将在利润上形成巨大负面跳变。

2. **当前调度状态下的违约概率**：
   - 给定某一候选调度方案，可以估算：
     - 当前至截止时间窗口内为该订单实际分配的总产能 `cap_assigned`；
     - 若 `cap_assigned < q_o`，则即便后续所有可用时段都满产，也注定无法按时完成，该订单属于**必违约订单**；
     - 若 `cap_assigned` 略大于 `q_o`，则该订单的违约风险较低；
     - 若仅略低于 `q_o`，则属于“边缘订单”，对其进行少量结构调整即可消除罚款。

综合这两点，可以定义每个订单的**风险分数**，并以此指导局部搜索：

- 高金额 × 边缘完成度 → **最高优先级**（极小调整即可避免巨大罚款）。
- 高金额 × 必违约 → 需要更大幅度的结构重排，但收益巨大。
- 低金额 × 必违约或边缘 → 可根据成本和整体策略合理放弃或降低优先级。

### 4.2 为什么只对高风险解 / 精英解做局部搜索

原 ILS/VNS 在“GA 最优解”上做随机局部扰动，从理论上可以改善解，但在当前业务结构下有两个问题：

- **计算资源分散**：
  - 每次局部搜索迭代都在随机位置做改变，很多修改作用在“低风险、低金额订单”上，对总体利润和罚款影响微弱，却消耗了大量解码与适应度评估时间。

- **缺乏与 GA 的角色分工**：
  - GA 已经较善于在全局空间中搜索“成本 / 收入”的平衡模式；
  - 局部搜索如果也在广义利润上随机摇摆，就与 GA 重复劳动，而没有充分利用其“在局部结构上做精细调整”的优势。

升级后的设计是：

- **仅在 GA 输出的“全局精英解”上触发局部搜索**：
  - 这些解已经在岛模型 GA 中经过长时间全局进化，具备较高利润和合理结构。
  - 局部搜索的角色是：
    - 在这些“已经很好的解”上进行**业务结构上的微调**，特别针对高风险订单的产能与时间布局。

- **仅对其中“高风险部分”应用邻域操作**：
  - 比如：
    - 针对高金额、边缘完成度的订单，尝试把其分配从高成本夜班调整到成本合适的白班，或从拥挤时段移动到稍空闲的时段。
    - 针对多个高风险订单之间的冲突，尝试重新分配产线或调整优先级顺序。

这样，局部搜索的“计算预算”就集中用在**最有可能改变罚款与利润的局部结构**上，让其真正成为“针对业务结构的精细调参器”，而不是“广义上的随机改良器”。

### 4.3 从随机邻域到目标导向邻域

在升级后的框架下，邻域不再是“对 Gene1/Gene2 随便交换”，而是**围绕以下两个目标导向规则设计**：

1. **高罚款风险 → 优先减少违约（促进订单完全完成）**
   - 邻域操作集中在：
     - 为高金额、边缘未完成的订单**腾挪产能**：
       - 在其时间窗口内，为其从低价值订单手中“借用”一些 slot；
       - 在不同产线间重新分配，以提高总可用产能。
     - 对必违约订单，尝试：
       - 把其部分分配前移或后移，观察是否能通过牺牲部分低价值订单来完成其主要部分，从而降低实际损失。
   - 这些邻域直接服务于“降低罚款”这一明确目标。

2. **高成本压力 → 优先结构调整（向低成本时段迁移）**
   - 当当前解中的夜班、高成本 slot 启用过多（人工成本偏高）时，局部搜索可以：
     - 选择部分低价值订单或接近完成的订单，将其产能从高成本 slot 迁移到低成本的白班 slot（若存在剩余产能）。
     - 在保证不显著提高罚款风险的前提下，压缩夜班产量，降低整体成本。

在编码层面，这意味着：

- 对 `Gene1` 的邻域不再是“随机选两个 slot 交换产品”，而是：
  - 有条件地选择“涉及高风险订单的 slot”或“位于高成本时间段的 slot”。
- 对 `Gene2` 的邻域不再是“随机交换两个订单位置”，而是：
  - 围绕高风险订单及与其冲突的订单局部调整优先级。

从 “随机邻域 + 贪心接受” 升级为 “风险标记 + 目标导向邻域 + 受控接受”，使局部搜索对问题结构具有更强的感知能力。

### 4.4 受控退火式接受：跳出局部最优，而非全面模拟退火

为了解决贪心策略“无法接受短期变差、难以跨越局部谷底”的问题，但又不希望引入完整、复杂的模拟退火框架，本次升级采用**受控退火式接受策略**：

- **基本思想**：
  - 在局部搜索早期，允许以较小概率接受略差的解；
  - 随着迭代次数增加（或改进次数变少），这一接受概率逐渐降低；
  - 只在局部搜索的上下文内使用，不改变 GA 的主进化逻辑。

- **与完整模拟退火的区别**：
  - 不设全局温度衰减计划，而是在 ILS/VNS 的固定迭代框架内，只在“比较当前解与邻域解”这一步使用一个简单的概率接受规则；
  - 不追求全局 Markov 链收敛性质，而是仅仅用于**偶尔跨越小的适应度谷**，回到更好的搜索区域。

- **典型应用场景**：
  - 为完成某个高金额订单，需要将其部分产能从白班移动到成本更高的夜班：
    - 短期看：成本上升，利润下降；
    - 长期看：若因此从“未完成”变为“完成”，罚款会从 10% 总额跳到 0，整体利润大幅增加；
    - 受控退火接受允许在局部搜索中**短暂接受夜班更多的方案**，从而找到最终罚款更低的调度结构。

与原 ILS/VNS 相比，本质差异在于：

- 原算法：局部搜索是“随机扰动 + 只接受更好解”的纯贪心微调器。
- 升级后：局部搜索变成“风险驱动的目标导向邻域 + 小概率接受略差解”的**结构化精化器**：
  - 聚焦在罚款风险高 / 成本压力大之处。
  - 主动为跨越罚款跳变预留“暂时变差”的缓冲区。

---

## 5. 升级后算法的整体执行流程

在保持原有“滚动调度主流程”不变的前提下，升级后算法的执行流程可概括为以下步骤（与 `docs/ALGORITHM.md` 第 4、5 章相对应）：

1. **滚动调度触发（每日 8:00）**
   - 根据当前日期和时间，计算起始 slot（例如 `time_to_slot(day, 8:00)`）。
   - 从订单管理器收集：
     - 所有未完成且已到达（`release_slot <= current_slot`）的订单；
     - 统计未来未到达订单数量，用于风险评估参考。
   - 冻结当前时间之前的所有 slot，形成固定前缀调度。

2. **岛模型 GA 并行进化**
   - 初始化多个岛（例如：利润导向岛、交付导向岛、探索导向岛），每个岛拥有：
     - 自己的初始种群（可部分复用历史解未执行部分作为精英初始化）；
     - 自己的 GA 参数配置（变异率、选择策略等）。
   - 在每个岛内部：
     - 按照标准 GA 流程执行若干代进化（选择、交叉、变异、精英保留）；
     - 计算适应度仍基于“总利润 = 收入 - 成本 - 罚款”。
   - 每隔若干代：
     - 触发一次精英迁移事件，按照异质偏好在不同岛之间交换少量精英个体。

3. **选取全局精英解**
   - 当各岛达到预设的最大代数或满足提前终止条件时：
     - 收集所有岛上的精英个体（例如各岛前若干名）；
     - 在统一的适应度函数下比较，选取一批**全局精英解**。
   - 这些精英解构成后续局部搜索的输入候选集（可以选取其中 1–k 个进行精化，根据计算预算调整）。

4. **风险驱动局部搜索精化**
   - 对每一个待精化的全局精英解：
     1. 基于当前解的调度结果，计算每个订单的风险分数：
        - 结合“潜在罚款金额 + 当前分配与需求的差距 + 距截止时间剩余窗口”等因素。
     2. 在高风险订单和高成本时段周围，构造目标导向的邻域：
        - 为高金额边缘订单腾挪产能；
        - 在不显著增加罚款风险的前提下，从高成本夜班迁移部分产量到低成本白班；
        - 调整高风险订单与其他订单的排队顺序。
     3. 在 ILS/VNS 框架内迭代：
        - 使用**风险优先策略**选择邻域和目标订单；
        - 对每一次邻域生成的新解，采用“改进必然接受 + 受控退火式概率接受略差解”的规则；
        - 当连续多次迭代未获得改进，且退火接受概率降至较低水平时，停止局部搜索。
   - 最终得到经“风险驱动精化”后的解，作为该调度周期的候选最终调度方案。

5. **输出最终方案并映射回系统**
   - 选取局部搜索结束后适应度最高的解：
     - 解码为完整的 `Schedule`（含 `y_{o,l,t}` 分配）；
     - 计算对当前规划窗口的收入、成本、罚款和利润指标。
   - 将该调度方案映射回全局时间轴，叠加在已冻结的历史调度之上。
   - 更新系统内的生产计划与可视化输出，进入当天的实际执行阶段。

从宏观角度看：

- **触发时机、输入输出接口、滚动调度逻辑完全不变**；
- 升级集中体现在：“如何在一次调度内部，从订单集合出发构造更强的解”。

---

## 6. 算法升级总结与定位

### 6.1 统一算法名称

在本次升级后，整个算法框架可以统一描述为：

> **岛模型并行 GA + 风险驱动局部搜索的滚动调度算法框架**

或简写为：

> **Island-GA + Risk-Guided LS 滚动调度框架**

### 6.2 升级带来的三点核心提升

1. **全局搜索能力增强（结构性多样性 + 多策略并存）**
   - 由单种群升级为岛模型并行 GA，使得：
     - 不同业务偏好的调度风格可以在不同岛内长期共存并各自深入；
     - 精英迁移在“利润岛 / 交付岛 / 探索岛”之间传递经验，综合利用不同视角的优势；
     - 即便个别岛早熟，整体系统仍具有充足的结构多样性，降低早熟收敛风险。

2. **局部优化针对性提升（从“随机微调”到“风险定向精化”）**
   - 局部搜索从“随机邻域 + 贪心接受”的通用微调器，转变为：
     - 以罚款风险为核心指标，对高金额、高风险订单进行优先处理；
     - 在产能和成本约束下，为关键订单主动腾挪资源、优化时间位置；
     - 使每一次局部搜索迭代都尽量围绕“降低罚款 / 平衡成本”这两个清晰目标展开。

3. **解的稳定性与鲁棒性提升（适应订单随机到达与罚款跳变）**
   - 面对订单随机到达和离散罚款：
     - 岛模型确保在多个调度周期中，系统始终保有多种策略风格，减少因初始种子差异导致的极端方案；
     - 风险驱动局部搜索为关键订单提供“最后一公里”的保护机制，即使在局部困难场景下，也尽量避免因轻微不足造成巨额罚款；
     - 受控退火接受为局部搜索提供有限的“跳出能力”，增强对不同数据场景的鲁棒性。

---

> **不可违背的目标总结**
>
> 在不改变现有“GA + ILS/VNS + 滚动调度”主流程的前提下，通过**岛模型并行 GA**增强全局搜索与多样性，通过**风险驱动的局部搜索（带受控退火接受）**针对罚款与成本结构做定向精化，系统性提升调度算法的全局搜索能力、局部优化针对性与解的稳定性。
